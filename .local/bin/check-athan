#!/usr/bin/python

# yoyomanzoor
# Uses ipinfo.io to get location and then uses aladhan.com to get prayer times

import sys
import argparse
import urllib.request
import json
import datetime

parser = argparse.ArgumentParser(description='Get prayer times')
# parser.add_argument('-h', '--help', action='store_true', help='Show help')
parser.add_argument('-d', '--date', action='store_true', help='Get date')
parser.add_argument('-t', '--time', action='store_true', help='Get time')
args = parser.parse_args()

def arabnum(western_num):
    t = western_num.maketrans('0123456789', '٠١٢٣٤٥٦٧٨٩')
    return western_num.translate(t)

def convert_time(time, convert_from, convert_to):
    return datetime.datetime.strptime(time, convert_from).time().strftime(convert_to)

def athan(r):

    url = 'https://ipinfo.io/loc'
    with urllib.request.urlopen(url) as response:
        ip = response.read().decode('utf-8')

    ip = ip.split("\n")[0].split(",")

    url = f'http://api.aladhan.com/timings?latitude={ip[0]}&longitude={ip[1]}&school=1&method=99&methodSettings=18,null,15'

    with urllib.request.urlopen(url) as response:
        html = response.read()

    convert_from = "%H:%M"
    wanted_time_format = "%I:%M %p"
    timings = json.loads(html)['data']['timings']
    del timings['Sunset']
    del timings['Imsak']
    del timings['Midnight']
    del timings['Firstthird']
    del timings['Lastthird']
    current_time = datetime.datetime.now().time()

    for name, time in timings.items():
        datetimed = datetime.datetime.strptime(timings[name], convert_from).time()

        if current_time < datetimed:
            next_prayer = [name, convert_time(time, convert_from, wanted_time_format)]
            break
        else:
            next_prayer = ['Fajr', convert_time(timings['Fajr'], convert_from, wanted_time_format)]
            # next_prayer = [name, convert_time(timings[name], convert_from, wanted_time_format)] # if including lastthird

    day = json.loads(html)['data']['date']['hijri']

    if r == 0:
        print(f'{day["weekday"]["ar"]} {arabnum(day["day"])} {day["month"]["ar"]}, {arabnum(day["year"])}')
    elif r == 1:
        print(f'{next_prayer[0]} {next_prayer[1]}')


# if args.help:
#     print('Usage: check-athan')
#     sys.exit()
if args.date:
    athan(0)
elif args.time:
    athan(1)
else:
    print('Usage: check-athan')
    print(args)
    sys.exit()
